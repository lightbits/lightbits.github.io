<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>Retrospective 59 minutes</title>
	<link rel="stylesheet" href="http://folk.ntnu.no/simeh/style.css">
	<!-- <link rel="shortcut icon" href="http://folk.ntnu.no/simeh/favicon.png" type="image/png" /> -->
	<!-- <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'> -->
	<script type="text/javascript" src="http://benweet.github.io/stackedit/lib/MathJax/MathJax.js?config=TeX-AMS_HTML"></script>
</head>

<body>

	<div id="main">

		<div id="title">
			<h1>Retrospective 59 Minutes</h1>
			<h2>Adventures in computer programming</h2>
		</div>

		<div id="pages">
			<a href="http://folk.ntnu.no/simeh/">top</a>
			 / 
			<a href="http://folk.ntnu.no/simeh/about">about</a>
			 / 
			<a href="http://folk.ntnu.no/simeh/projects" class="active_page">[projects]</a>
			 / 
			<a href="http://folk.ntnu.no/simeh/stuff">stuff</a>
			 / 
			<a href="http://folk.ntnu.no/simeh/blog">blog</a>
		</div>

		<div id="content">
		<div class="project">

<h1 class="wmd-title" id="two-dimensional-photon-simulator">Two-dimensional Photon Simulator</h1>

<p>Browsing the <a href="http://forums.tigsource.com/">Tigsource forums</a> is always a good idea if you need inspiration. I saw <a href="http://forums.tigsource.com/index.php?topic=31378.0">a post</a> about simulating photons in a 2D image, and couldn't help but try it out myself.</p>

<p><img src="http://folk.ntnu.no/simeh/projects/photons/result_500000.png" alt="500000 photons" title=""></p>

<p>The above image simulates half a million photons bouncing around in a scene. It took about 30 secs to render on one thread of an Intel Core i5 @ 1.60 GHz.</p>

<p>The basic idea is simple:</p>

<ul>
<li>The scene consists of a light source which emits photons</li>
<li>Each photon has a color, position and direction, and traverses the scene in fixed steps</li>
<li>In each step we:
<ul><li>Accumulate its color in a lightbuffer</li>
<li>Check if it collides with a surface, and emit a photon in a new direction with the color multiplied with the surface</li></ul></li>
<li>(Repeat some thousand times for many photons)</li>
</ul>

<p>Finally, we blend the lightbuffer with the original image by multiplying the pixels together. This means we need three seperate images: a colored texture (unlit scene), a collision texture describing what surfaces are collidable, and a texture to hold the photon colors.</p>

<p>Naturally, the values in the lightbuffer will quickly exceed the range of 8-bit colors, so we need to use High-Dynamic-Range images to get greater range. Because I'm lazy I just pack the pixels into an array of 32-bit floats, one for each R, G and B component. (Yes it uses a lot of RAM...).</p>

<p>Now the problem is that after we multiply the light with the texture, we end up with an image that can't be displayed on todays monitors, as the RGB values are a hundred times greater than 1.0. If we clamp each component to a [0, 1], we get an image which is completely white some places, and completely black otherwise.</p>

<p><img src="http://folk.ntnu.no/simeh/projects/photons/result_clamped.bmp" alt="Clamped" title=""></p>

<p>In the above image I clamped the lightbuffer to [0, 1] before multiplying with the texture. Clearly not cool at all.</p><h3 class="wmd-title" id="queue-reinhard!">Queue Reinhard!</h3>

<p>To fix this, we use <strong>tonemapping</strong>. Which is basically a way to compress a HDR image to a displayable image, while preserving relative brightness and color. Reinhard's tonemap operator is probably one of the more popular ones, and it seemed simple to implement, so I went with that.</p>

<p>The idea behind tonemapping is to first find a measure of how bright the overall image is (luminance), and then scale the brightness of each pixel appropriately using that. More advanced techniques calculate local luminance and does a better job at enhancing dark regions, but I didn't go with that.</p>

<p>The first thing we need to do is calculate the <strong>log-average-luminance</strong>:
<span class="MathJax_Preview"></span><div class="MathJax_Display" role="textbox" aria-readonly="true" style="text-align: center;"><span class="MathJax" id="MathJax-Element-1518-Frame" style=""><nobr><span class="math" id="MathJax-Span-25765" style="width: 20.295em; display: inline-block;"><span style="display: inline-block; position: relative; width: 15.371em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(2.005em 1000.003em 5.414em -0.43em); top: -3.948em; left: 0.003em;"><span class="mrow" id="MathJax-Span-25766"><span class="msubsup" id="MathJax-Span-25767"><span style="display: inline-block; position: relative; width: 1.193em; height: 0px;"><span style="position: absolute; clip: rect(2.979em 1000.003em 4.169em -0.43em); top: -4.002em; left: 0.003em;"><span class="texatom" id="MathJax-Span-25768"><span class="mrow" id="MathJax-Span-25769"><span class="munderover" id="MathJax-Span-25770"><span style="display: inline-block; position: relative; width: 0.652em; height: 0px;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mi" id="MathJax-Span-25771" style="font-family: MathJax_Math; font-style: italic;">L</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(1.41em 1000.003em 1.788em -0.43em); top: -2.432em; left: 0.111em;"><span class="mo" id="MathJax-Span-25772" style="font-family: MathJax_Main;">¯</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -1.999em; left: 0.652em;"><span class="mi" id="MathJax-Span-25773" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span><span class="mo" id="MathJax-Span-25774" style="font-family: MathJax_Main; padding-left: 0.273em;">=</span><span class="mi" id="MathJax-Span-25775" style="font-family: MathJax_Main; padding-left: 0.273em;">exp</span><span class="mrow" id="MathJax-Span-25776"><span class="mo" id="MathJax-Span-25777" style="vertical-align: 1.788em;"><span style="display: inline-block; position: relative; width: 0.869em; height: 0px;"><span style="position: absolute; font-family: MathJax_Size4; top: -2.865em; left: 0.003em;">⎛<span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; font-family: MathJax_Size4; top: -1.567em; left: 0.003em;">⎝<span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span><span class="mfrac" id="MathJax-Span-25778" style="padding-left: 0.111em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 1.031em; height: 0px;"><span style="position: absolute; clip: rect(1.356em 1000.003em 2.33em -0.376em); top: -2.865em; left: 50%; margin-left: -0.214em;"><span class="mn" id="MathJax-Span-25779" style="font-family: MathJax_Main;">1</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -1.458em; left: 50%; margin-left: -0.43em;"><span class="mi" id="MathJax-Span-25780" style="font-family: MathJax_Math; font-style: italic;">N<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.111em;"></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 1.031em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span><span class="munderover" id="MathJax-Span-25781" style="padding-left: 0.165em;"><span style="display: inline-block; position: relative; width: 1.41em; height: 0px;"><span style="position: absolute; clip: rect(1.951em 1000.003em 3.682em -0.43em); top: -3.082em; left: 0.003em;"><span class="mo" id="MathJax-Span-25782" style="font-family: MathJax_Size2; vertical-align: 0.003em;">∑</span><span style="display: inline-block; width: 0px; height: 3.087em;"></span></span><span style="position: absolute; clip: rect(1.68em 1000.003em 2.6em -0.484em); top: -1.134em; left: 0.219em;"><span class="texatom" id="MathJax-Span-25783"><span class="mrow" id="MathJax-Span-25784"><span class="mi" id="MathJax-Span-25785" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-25786" style="font-size: 70.7%; font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-25787" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span><span class="mi" id="MathJax-Span-25788" style="font-family: MathJax_Main; padding-left: 0.165em;">ln</span><span class="mo" id="MathJax-Span-25789"></span><span class="mo" id="MathJax-Span-25790" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-25791" style="font-family: MathJax_Math; font-style: italic;">δ<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25792" style="font-family: MathJax_Main; padding-left: 0.219em;">+</span><span class="msubsup" id="MathJax-Span-25793" style="padding-left: 0.219em;"><span style="display: inline-block; position: relative; width: 1.193em; height: 0px;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mi" id="MathJax-Span-25794" style="font-family: MathJax_Math; font-style: italic;">L</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; top: -1.999em; left: 0.652em;"><span class="mi" id="MathJax-Span-25795" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span><span class="mo" id="MathJax-Span-25796" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-25797" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-25798" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-25799" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.165em;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25800" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-25801" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-25802" style="vertical-align: 1.788em;"><span style="display: inline-block; position: relative; width: 0.869em; height: 0px;"><span style="position: absolute; font-family: MathJax_Size4; top: -2.865em; left: 0.003em;">⎞<span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; font-family: MathJax_Size4; top: -1.567em; left: 0.003em;">⎠<span style="display: inline-block; width: 0px; height: 4.007em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 3.953em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 4.218em; vertical-align: -1.782em;"></span></span></nobr></span></div><script type="math/tex; mode=display" id="MathJax-Element-1518">
\bar{L}_w = \exp\left ( \frac{1}{N} \sum_{x, y} \ln(\delta + L_w(x, y)) \right )
</script>
That is, we sum up the logarithm of the luminance <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1519-Frame" role="textbox" aria-readonly="true" style=""><nobr><span class="math" id="MathJax-Span-25803" style="width: 1.68em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.247em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.492em -0.43em); top: -2.162em; left: 0.003em;"><span class="mrow" id="MathJax-Span-25804"><span class="msubsup" id="MathJax-Span-25805"><span style="display: inline-block; position: relative; width: 1.193em; height: 0px;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mi" id="MathJax-Span-25806" style="font-family: MathJax_Math; font-style: italic;">L</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; top: -1.999em; left: 0.652em;"><span class="mi" id="MathJax-Span-25807" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.289em; vertical-align: -0.282em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1519">L_w</script> of each pixel, divide by the number of pixels <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1520-Frame" role="textbox" aria-readonly="true" style=""><nobr><span class="math" id="MathJax-Span-25808" style="width: 1.247em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.923em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mrow" id="MathJax-Span-25809"><span class="mi" id="MathJax-Span-25810" style="font-family: MathJax_Math; font-style: italic;">N<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.111em;"></span></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.075em; vertical-align: -0.068em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1520">N</script>, and take the inverse logarithm <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1521-Frame" role="textbox" aria-readonly="true" style=""><nobr><span class="math" id="MathJax-Span-25811" style="width: 2.005em; display: inline-block;"><span style="display: inline-block; position: relative; width: 1.518em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.572em 1000.003em 2.546em -0.43em); top: -2.162em; left: 0.003em;"><span class="mrow" id="MathJax-Span-25812"><span class="mi" id="MathJax-Span-25813" style="font-family: MathJax_Main;">exp</span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.004em; vertical-align: -0.354em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1521">\exp</script>. </p>

<p>Why the log of each luminance, and not just the luminance? I don't know the exact reasoning, but I assume it provides a better measure of the overall brightness.</p>

<p>We now scale the luminance by some exposure value <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1522-Frame" role="textbox" aria-readonly="true" style=""><nobr><span class="math" id="MathJax-Span-25814" style="width: 0.76em; display: inline-block;"><span style="display: inline-block; position: relative; width: 0.544em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.572em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mrow" id="MathJax-Span-25815"><span class="mi" id="MathJax-Span-25816" style="font-family: MathJax_Math; font-style: italic;">a</span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 0.718em; vertical-align: -0.068em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1522">a</script>:
<span class="MathJax_Preview"></span><div class="MathJax_Display" role="textbox" aria-readonly="true" style="text-align: center;"><span class="MathJax" id="MathJax-Element-1523-Frame" style=""><nobr><span class="math" id="MathJax-Span-25817" style="width: 12.394em; display: inline-block;"><span style="display: inline-block; position: relative; width: 9.364em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(0.869em 1000.003em 3.304em -0.43em); top: -2.162em; left: 0.003em;"><span class="mrow" id="MathJax-Span-25818"><span class="mi" id="MathJax-Span-25819" style="font-family: MathJax_Math; font-style: italic;">L</span><span class="mo" id="MathJax-Span-25820" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-25821" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-25822" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-25823" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.165em;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25824" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-25825" style="font-family: MathJax_Main; padding-left: 0.273em;">=</span><span class="mfrac" id="MathJax-Span-25826" style="padding-left: 0.381em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 1.356em; height: 0px;"><span style="position: absolute; clip: rect(1.572em 1000.003em 2.33em -0.43em); top: -2.865em; left: 50%; margin-left: -0.268em;"><span class="mi" id="MathJax-Span-25827" style="font-family: MathJax_Math; font-style: italic;">a</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(2.979em 1000.003em 4.332em -0.43em); top: -3.136em; left: 50%; margin-left: -0.593em;"><span class="msubsup" id="MathJax-Span-25828"><span style="display: inline-block; position: relative; width: 1.193em; height: 0px;"><span style="position: absolute; clip: rect(2.979em 1000.003em 4.169em -0.43em); top: -4.002em; left: 0.003em;"><span class="texatom" id="MathJax-Span-25829"><span class="mrow" id="MathJax-Span-25830"><span class="munderover" id="MathJax-Span-25831"><span style="display: inline-block; position: relative; width: 0.652em; height: 0px;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mi" id="MathJax-Span-25832" style="font-family: MathJax_Math; font-style: italic;">L</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(1.41em 1000.003em 1.788em -0.43em); top: -2.432em; left: 0.111em;"><span class="mo" id="MathJax-Span-25833" style="font-family: MathJax_Main;">¯</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; top: -1.999em; left: 0.652em;"><span class="mi" id="MathJax-Span-25834" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 1.356em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span><span class="msubsup" id="MathJax-Span-25835" style="padding-left: 0.165em;"><span style="display: inline-block; position: relative; width: 1.193em; height: 0px;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mi" id="MathJax-Span-25836" style="font-family: MathJax_Math; font-style: italic;">L</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; top: -1.999em; left: 0.652em;"><span class="mi" id="MathJax-Span-25837" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">w</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span><span class="mo" id="MathJax-Span-25838" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-25839" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-25840" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-25841" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.165em;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25842" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 2.932em; vertical-align: -1.354em;"></span></span></nobr></span></div><script type="math/tex; mode=display" id="MathJax-Element-1523">
L(x, y) = \frac{a}{\bar{L}_w} L_w(x, y)
</script>
I use an exposure of about 0.3, which gives a bright enough image. Finally we apply the tonemap operator:
<span class="MathJax_Preview"></span><div class="MathJax_Display" role="textbox" aria-readonly="true" style="text-align: center;"><span class="MathJax" id="MathJax-Element-1524-Frame" style=""><nobr><span class="math" id="MathJax-Span-25843" style="width: 17.643em; display: inline-block;"><span style="display: inline-block; position: relative; width: 13.369em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(-0.863em 1000.003em 3.304em -0.43em); top: -2.162em; left: 0.003em;"><span class="mrow" id="MathJax-Span-25844"><span class="msubsup" id="MathJax-Span-25845"><span style="display: inline-block; position: relative; width: 1.139em; height: 0px;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mi" id="MathJax-Span-25846" style="font-family: MathJax_Math; font-style: italic;">L</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; top: -1.999em; left: 0.652em;"><span class="mi" id="MathJax-Span-25847" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">d<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span><span class="mo" id="MathJax-Span-25848" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-25849" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-25850" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-25851" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.165em;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25852" style="font-family: MathJax_Main;">)</span><span class="mo" id="MathJax-Span-25853" style="font-family: MathJax_Main; padding-left: 0.273em;">=</span><span class="mfrac" id="MathJax-Span-25854" style="padding-left: 0.381em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 8.444em; height: 0px;"><span style="position: absolute; clip: rect(1.626em 1000.003em 4.386em -0.43em); top: -4.651em; left: 50%; margin-left: -4.164em;"><span class="mrow" id="MathJax-Span-25855"><span class="mi" id="MathJax-Span-25856" style="font-family: MathJax_Math; font-style: italic;">L</span><span class="mo" id="MathJax-Span-25857" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-25858" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-25859" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-25860" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.165em;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25861" style="font-family: MathJax_Main;">)</span><span class="mrow" id="MathJax-Span-25862"><span class="mo" id="MathJax-Span-25863" style="vertical-align: 0.003em;"><span style="font-family: MathJax_Size3;">(</span></span><span class="mn" id="MathJax-Span-25864" style="font-family: MathJax_Main;">1</span><span class="mo" id="MathJax-Span-25865" style="font-family: MathJax_Main; padding-left: 0.219em;">+</span><span class="mfrac" id="MathJax-Span-25866" style="padding-left: 0.327em; padding-right: 0.111em;"><span style="display: inline-block; position: relative; width: 2.113em; height: 0px;"><span style="position: absolute; clip: rect(1.464em 1000.003em 2.492em -0.484em); top: -2.757em; left: 50%; margin-left: -0.971em;"><span class="mrow" id="MathJax-Span-25867"><span class="mi" id="MathJax-Span-25868" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">L</span><span class="mo" id="MathJax-Span-25869" style="font-size: 70.7%; font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-25870" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-25871" style="font-size: 70.7%; font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-25872" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25873" style="font-size: 70.7%; font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(3.195em 1000.003em 4.386em -0.484em); top: -3.46em; left: 50%; margin-left: -0.809em;"><span class="msubsup" id="MathJax-Span-25874"><span style="display: inline-block; position: relative; width: 1.68em; height: 0px;"><span style="position: absolute; clip: rect(1.518em 1000.003em 2.33em -0.484em); top: -2.162em; left: 0.003em;"><span class="mi" id="MathJax-Span-25875" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">L</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(1.68em 1000.003em 2.33em -0.484em); top: -2.432em; left: 0.49em;"><span class="mn" id="MathJax-Span-25876" style="font-size: 50%; font-family: MathJax_Main;">2</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(1.68em 1000.003em 2.33em -0.484em); top: -1.999em; left: 0.49em;"><span class="texatom" id="MathJax-Span-25877"><span class="mrow" id="MathJax-Span-25878"><span class="mi" id="MathJax-Span-25879" style="font-size: 50%; font-family: MathJax_Math; font-style: italic;">w</span><span class="mi" id="MathJax-Span-25880" style="font-size: 50%; font-family: MathJax_Math; font-style: italic;">h</span><span class="mi" id="MathJax-Span-25881" style="font-size: 50%; font-family: MathJax_Math; font-style: italic;">i</span><span class="mi" id="MathJax-Span-25882" style="font-size: 50%; font-family: MathJax_Math; font-style: italic;">t</span><span class="mi" id="MathJax-Span-25883" style="font-size: 50%; font-family: MathJax_Math; font-style: italic;">e</span></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span><span style="display: inline-block; width: 0px; height: 4.007em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 2.113em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span><span class="mo" id="MathJax-Span-25884" style="vertical-align: 0.003em;"><span style="font-family: MathJax_Size3;">)</span></span></span></span><span style="display: inline-block; width: 0px; height: 3.249em;"></span></span><span style="position: absolute; clip: rect(1.247em 1000.003em 2.6em -0.376em); top: -1.458em; left: 50%; margin-left: -2.324em;"><span class="mrow" id="MathJax-Span-25885"><span class="mn" id="MathJax-Span-25886" style="font-family: MathJax_Main;">1</span><span class="mo" id="MathJax-Span-25887" style="font-family: MathJax_Main; padding-left: 0.219em;">+</span><span class="mi" id="MathJax-Span-25888" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.219em;">L</span><span class="mo" id="MathJax-Span-25889" style="font-family: MathJax_Main;">(</span><span class="mi" id="MathJax-Span-25890" style="font-family: MathJax_Math; font-style: italic;">x</span><span class="mo" id="MathJax-Span-25891" style="font-family: MathJax_Main;">,</span><span class="mi" id="MathJax-Span-25892" style="font-family: MathJax_Math; font-style: italic; padding-left: 0.165em;">y<span style="display: inline-block; overflow: hidden; height: 1px; width: 0.003em;"></span></span><span class="mo" id="MathJax-Span-25893" style="font-family: MathJax_Main;">)</span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; clip: rect(0.869em 1000.003em 1.247em -0.484em); top: -1.296em; left: 0.003em;"><span style="border-left-width: 8.444em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.25px; vertical-align: 0.003em;"></span><span style="display: inline-block; width: 0px; height: 1.085em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 5.218em; vertical-align: -1.354em;"></span></span></nobr></span></div><script type="math/tex; mode=display" id="MathJax-Element-1524">
L_d(x, y) = \frac{L(x, y) \left(1 + \frac{L(x, y)}{L_{white}^2} \right)}{1 + L(x, y)}
</script>
which compresses the luminance to a displayable range. <span class="MathJax_Preview"></span><span class="MathJax" id="MathJax-Element-1525-Frame" role="textbox" aria-readonly="true" style=""><nobr><span class="math" id="MathJax-Span-25894" style="width: 3.249em; display: inline-block;"><span style="display: inline-block; position: relative; width: 2.438em; height: 0px; font-size: 132%;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.492em -0.43em); top: -2.162em; left: 0.003em;"><span class="mrow" id="MathJax-Span-25895"><span class="msubsup" id="MathJax-Span-25896"><span style="display: inline-block; position: relative; width: 2.384em; height: 0px;"><span style="position: absolute; clip: rect(1.301em 1000.003em 2.33em -0.43em); top: -2.162em; left: 0.003em;"><span class="mi" id="MathJax-Span-25897" style="font-family: MathJax_Math; font-style: italic;">L</span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span><span style="position: absolute; top: -1.999em; left: 0.652em;"><span class="texatom" id="MathJax-Span-25898"><span class="mrow" id="MathJax-Span-25899"><span class="mi" id="MathJax-Span-25900" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">w</span><span class="mi" id="MathJax-Span-25901" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">h</span><span class="mi" id="MathJax-Span-25902" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">i</span><span class="mi" id="MathJax-Span-25903" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">t</span><span class="mi" id="MathJax-Span-25904" style="font-size: 70.7%; font-family: MathJax_Math; font-style: italic;">e</span></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span></span></span><span style="display: inline-block; width: 0px; height: 2.167em;"></span></span></span><span style="border-left-width: 0.004em; border-left-style: solid; display: inline-block; overflow: hidden; width: 0px; height: 1.289em; vertical-align: -0.282em;"></span></span></nobr></span><script type="math/tex" id="MathJax-Element-1525">L_{white}</script> is the smallest luminance that will be mapped to pure white.</p>

<p>The trick now is how to scale the RGB values using the scaled luminance. From what I've read, you can convert from linear RGB into CIE xyY. The advantage of this color space is that the luminance is stored as the Y component, and the chromaticity xy is independent of it. This means you can convert from RGB to xyY, perform tonemapping on the Y value, and convert back to RGB.</p>

<p>A <a href="http://imdoingitwrong.wordpress.com/tag/hdr/">much simpler approach</a> though, is to calculate the luminance from the RGB values directly, perform tonemapping on this value, and scale the RGB values appropriately:</p>

<pre><code>vec3 pixel = img.getPixel(x, y);
float R = pixel.x;
float G = pixel.y;
float B = pixel.z;

// Calculate pixel luminance
float Lp = 0.2126f * R + 0.7152f * G + 0.0722 * B;

// Scale the pixel luminance to a middle gray zone
float L = Lp * exposure / lumAvg;

// Apply modified tonemapping operator and compress luminance to displayable range
float Ld = L * (1.0f + (L / (white * white))) / (1.0f + L);

// Scale and clamp all colors by the relative luminance gain
float scale = Ld / Lp;
R = std::min(R * scale, 1.0f);
G = std::min(G * scale, 1.0f);
B = std::min(B * scale, 1.0f);
img.setPixel(x, y, vec3(R, G, B));
</code></pre>

<p>Giving that a whirl gives the scene shown at the top. In that scene I set the exposure to 0.3, and the white to 64.0. To prevent unlit places from being completely black, I add a small ambient light to the lightbuffer before simulation.</p><h3 class="wmd-title" id="pictures!">Pictures!</h3>

<p>Here's it running on a mario level, with a hundred thousand photons:</p>

<p><img src="http://folk.ntnu.no/simeh/projects/photons/mariotthousand.png" alt="mariotthousand" title=""></p>

<p>Half a million photons:</p>

<p><img src="http://folk.ntnu.no/simeh/projects/photons/mariohmillion.png" alt="mariohmillion" title=""></p>

<p>One million photons:</p>

<p><img src="http://folk.ntnu.no/simeh/projects/photons/mariomillion.png" alt="mariomillion" title=""></p><h2 class="wmd-title" id="resources">Resources</h2>

<p>The following links really helped while trying to implement a tonemap operator:</p>

<ul>
<li><a href="http://www.cs.utah.edu/~reinhard/cdrom/">The Reinhard tonemapping algorithm</a></li>
<li><a href="http://mynameismjp.wordpress.com/2010/04/30/a-closer-look-at-tone-mapping/">mynameisjp: A closer look at tonemapping</a></li>
<li><a href="http://imdoingitwrong.wordpress.com/tag/hdr/">imdoingitwrong's blogpost</a></li>
</ul>

<h2>Code</h2>
<p>The code for the project can be found on Github: <a href="https://github.com/lightbits/photons">https://github.com/lightbits/photons</a></p>

			<!-- <table border="1" cellpadding="5" cellspacing="0">
			<thead>
				<tr>
					<th>TASK</th>
					<th>COMPLETED BY</th>
				</tr>
			</thead>
			<tbody>
				<tr class="row1"><td>Conceptualization</td><td>Both</td></tr>
				<tr class="row2"><td>Verilog design and coding</td><td>Both</td></tr>
				<tr class="row1"><td>Physical ocarina construction</td><td>Joe</td></tr>
				<tr class="row2"><td>Wiring of ocarina</td><td>Evan</td></tr>
				<tr class="row1"><td>Report writing</td><td>Both</td></tr>
				<tr class="row2"><td>Website construction</td><td>Evan</td></tr>
			</tbody>
		</table> -->

<!-- <h2>Resources</h2>
<p><a href="http://imdoingitwrong.wordpress.com/tag/hdr/">imdoingitwrong's blog</a></p>
<p><a href="http://www.poynton.com/notes/colour_and_gamma/ColorFAQ.html#RTFToC1">ColorFAQ</a></p>
<p><a href="http://www.gamedev.net/topic/407348-reinhards-tone-mapping-operator/">Gamedev.net</a>
<p><a href="http://www.anyhere.com/gward/hdrenc/hdr_encodings.html">HDR Encodings</a></p>
<p><a href="http://www.xnainfo.com/content.php?content=28">XNA HDR sample</a></p>
<p><a href="view-source:http://threejs.org/examples/webgl_hdr.html">WebGL HDR sample</a></p>
<p><a href="http://www.banterle.com/francesco/toolkit.php">HDR Toolkit</a></p>
<p><a href="http://spidergl.org/example.php?id=13">SpiderGL Example 13: HDR Texture</a></p> -->

		</div>
		</div>
	</div>
</body>
</html>